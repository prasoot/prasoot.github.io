<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GA4 ‚Üí Server GTM ‚Üí Azure Databricks Runbook</title>
  <!-- Mermaid CDN -->
  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: true });
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; background: #f9f9f9; color: #333; }
    h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
    h2 { color: #2c3e50; margin-top: 2rem; }
    h3 { color: #34495e; margin-top: 1rem; }
    p, li { font-size: 15px; line-height: 1.6; }
    ul { margin-bottom: 1rem; }
    code, pre { background: #f4f4f4; padding: 5px; border-radius: 4px; }
    .check { color: green; font-weight: bold; }
    .diagram { text-align: center; margin: 1.5rem 0; }
    .mermaid text {
  white-space: pre-wrap;
  word-wrap: break-word;
}
  </style>
</head>
<body>
  <h1>üìò Runbook: GA4 ‚Üí Server GTM ‚Üí Azure Databricks</h1>

  <h2>Architecture Overview</h2>
  <p>The following diagram illustrates the end-to-end data flow:</p>
    <div class="mermaid">
    flowchart LR
      U["User<br/>Browser"]
      W["GTM Web Container<br/>Fires GA4 Config Tag"]
      S["sGTM Server Container<br/>Receives events via transport_url"]
      GA["Google Analytics<br/>(Reporting)"]
      AF["Azure Function<br/>HTTP Trigger"]
      EH["Azure Event Hub<br/>(Capture Enabled)"]
      ADLS["ADLS Gen2<br/>Raw Event Storage"]
      DB["Azure Databricks<br/>Autoloader ‚Üí Delta Tables"]

      U --> W
      W --> S
      S --> GA
      S --> AF
      AF --> EH
      EH --> ADLS
      ADLS --> DB
  </div>
  <!--
<div class="mermaid">
    sequenceDiagram
      participant U as User<br/>Browser
      participant W as GTM Web<br/>Container
      participant S as sGTM Server<br/>Container
      participant AF as Azure<br/>Function
      participant EH as Event Hub
      participant D as Databricks

      U->>W: Page Load<br/>fires GA4 Config Tag
      W->>S: Send page_view<br/>via transport_url
      S->>AF: Forward event<br/>as JSON
      AF->>EH: Push to Event Hub
      EH->>D: Capture ‚Üí Delta Tables
  </div>
  <div class="diagram">
    <img src="GADatatoAzureEndToEnd.png" 
         alt="Architecture Diagram" width="1800">
  </div>
  -->

  <p><b>Data Flow:</b> Browser ‚Üí analytics.beyondscreen.online (sGTM) ‚Üí GA4 + Azure Function ‚Üí Event Hub ‚Üí ADLS ‚Üí Databricks</p>

  <h2>1. Website Setup</h2>
  <ul>
    <li class="check">Host website on GitHub Pages (<code>prasoot.github.io</code>).</li>
    <li class="check">Register custom domain in GoDaddy (<code>beyondscreen.online</code>).</li>
    <li class="check">Configure GoDaddy DNS:<br>- www.beyondscreen.online ‚Üí CNAME ‚Üí prasoot.github.io<br>- Optional root ANAME/ALIAS ‚Üí GitHub‚Äôs IPs.</li>
    <li class="check">Add GTM container snippet to &lt;head&gt; and &lt;body&gt;.</li>
    <li class="check">Remove direct gtag.js GA snippet (avoid duplicate hits).</li>
  </ul>

  <h2>2. GTM Web Container</h2>
  <ul>
    <li class="check">Create GA4 Configuration Tag (Measurement ID: G-L70NLL6EC4).</li>
    <li class="check">Set <code>transport_url = https://analytics.beyondscreen.online</code>.</li>
    <li class="check">Create GA4 Event Tags linked to this Config Tag.</li>
    <li class="check">Publish and verify in DevTools ‚Üí network ‚Üí collect.</li>
  </ul>

  <h2>3. First Party subdomain setup for sGTM</h2>
  <ul>
    <li class="check">Create subdomain: analytics.beyondscreen.online ‚Üí CNAME ghs.googlehosted.com.</li>
    <li class="check">Map custom domain in Cloud Run and wait for SSL.</li>
    <li class="check">Verify health check: <code>https://analytics.beyondscreen.online/__gtmhealthz ‚Üí 200 OK</code>.</li>
  </ul>

  <h2>4. sGTM Server Container (Cloud Run)</h2>
  <ul>
    <li class="check">Deploy server container. Add GA4 (Web) client.</li>
    <li class="check">Add GA4 Forwarder Tag and Azure Forwarder Tag (HTTP POST to Azure Function URL).</li>
  </ul>
 <!--<pre><code>{
  "ts":"{{Event Timestamp Micros}}",
  "client_id":"{{Client ID}}",
  "session_id":"{{Session ID}}",
  "event_name":"{{Event Name}}",
  "params": {{EV - event_params}}
}</code></pre>
--> 
  <h2>5. Azure Function</h2>
  <ul>
    <li class="check">Create Function App ‚Üí Python 3.10 ‚Üí Consumption plan.</li>
    <li class="check">Add HTTP Trigger function (<code>ingest</code>).</li>
    <li class="check">Code parses GA4 JSON and forwards to Event Hub.</li>
  </ul>
  <!--
  <pre><code>from azure.eventhub import EventHubProducerClient, EventData
import os, logging, json, azure.functions as func

producer = EventHubProducerClient.from_connection_string(
    os.environ["EH_CONN"], eventhub_name=os.environ["EH_NAME"]
)

def main(req: func.HttpRequest) -> func.HttpResponse:
    body = req.get_body().decode("utf-8")
    try:
        data = json.loads(body)
        batch = producer.create_batch()
        batch.add(EventData(body))
        producer.send_batch(batch)
        return func.HttpResponse(status_code=204)
    except Exception as e:
        logging.error(f"Parse error: {body[:200]}")
        return func.HttpResponse(status_code=202)</code></pre>
-->
  <h2>6. Azure Event Hub</h2>
  <ul>
    <li class="check">Create Event Hub namespace (<code>ga4-hub-ns</code>).</li>
    <li class="check">Create Event Hub (<code>ga4-events</code>).</li>
    <li class="check">Enable Capture ‚Üí ADLS Gen2 (Avro/Parquet).</li>
    <li class="check">Verify metrics ‚Üí ‚ÄúIncoming Messages‚Äù increasing.</li>
  </ul>

  <h2>7. ADLS Gen2</h2>
  <ul>
    <li class="check">Create storage account with hierarchical namespace.</li>
    <li class="check">Create container <code>ga4-raw</code>.</li>
    <li class="check">Event Hub Capture writes Avro/Parquet files here.</li>
  </ul>

  <h2>8. Azure Databricks</h2>
  <ul>
    <li class="check">Create workspace and mount ADLS Gen2.</li>
    <li class="check">Ingest via Autoloader:</li>
  </ul>
  <!--
  <pre><code>df = (spark.readStream.format("cloudFiles")
      .option("cloudFiles.format", "avro")
      .load("abfss://ga4-raw@&lt;storageaccount&gt;.dfs.core.windows.net/"))
df.writeStream.format("delta").option("checkpointLocation", "/mnt/checkpoints/ga4")\\
   .table("ga4_bronze_events")</code></pre>
-->
  <h2>9. Validation</h2>
  <ul>
    <li class="check">Browser DevTools ‚Üí only analytics.beyondscreen.online.</li>
    <li class="check">sGTM Preview ‚Üí GA4 + Azure forwarders firing.</li>
    <li class="check">Azure Function logs ‚Üí GA4 ingest function triggered.</li>
    <li class="check">Event Hub metrics increasing.</li>
    <li class="check">ADLS ‚Üí new files arriving.</li>
    <li class="check">Databricks ‚Üí row counts increasing.</li>
  </ul>

  <h2>‚úÖ End State</h2>
  <p>All GA4 hits go via your <b>first-party domain</b> ‚Üí sGTM ‚Üí GA4 + Azure ‚Üí Event Hub ‚Üí ADLS ‚Üí Databricks.<br>
  You get analytics in GA + raw data in Azure for advanced analysis & ML.</p>
</body>
</html>
